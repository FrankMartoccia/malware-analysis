package com.umeng.analytics.pro;

import android.content.Context;
import android.content.SharedPreferences;
import android.text.TextUtils;
import com.umeng.analytics.AnalyticsConfig;
import com.umeng.analytics.a;
import com.umeng.analytics.pro.s;
import com.umeng.analytics.pro.w;
import java.lang.reflect.Method;
import org.json.JSONObject;
/* compiled from: SessionTracker.java */
/* loaded from: classes.dex */
public class bd {

    /* renamed from: a  reason: collision with root package name */
    private static final String f1077a = "session_start_time";
    private static final String b = "session_end_time";
    private static final String c = "session_id";
    private static String f = null;
    private static Context g = null;
    private final String d = "a_start_time";
    private final String e = "a_end_time";

    public boolean a(Context context) {
        SharedPreferences a2 = ba.a(context);
        String string = a2.getString(c, null);
        if (string == null) {
            return false;
        }
        long j = a2.getLong(f1077a, 0L);
        long j2 = a2.getLong(b, 0L);
        if (j2 == 0 || Math.abs(j2 - j) > 86400000) {
        }
        try {
            JSONObject jSONObject = new JSONObject();
            jSONObject.put(s.c.a.f1205a, string);
            jSONObject.put("__e", j);
            jSONObject.put(s.c.a.g, j2);
            double[] location = AnalyticsConfig.getLocation();
            if (location != null) {
                JSONObject jSONObject2 = new JSONObject();
                jSONObject2.put(x.ae, location[0]);
                jSONObject2.put(x.af, location[1]);
                jSONObject2.put("ts", System.currentTimeMillis());
                jSONObject.put(s.c.a.e, jSONObject2);
            }
            Class<?> cls = Class.forName("android.net.TrafficStats");
            Method method = cls.getMethod("getUidRxBytes", Integer.TYPE);
            Method method2 = cls.getMethod("getUidTxBytes", Integer.TYPE);
            int i = context.getApplicationInfo().uid;
            if (i == -1) {
                return false;
            }
            long longValue = ((Long) method.invoke(null, Integer.valueOf(i))).longValue();
            long longValue2 = ((Long) method2.invoke(null, Integer.valueOf(i))).longValue();
            if (longValue > 0 && longValue2 > 0) {
                JSONObject jSONObject3 = new JSONObject();
                jSONObject3.put(x.aj, longValue);
                jSONObject3.put(x.ai, longValue2);
                jSONObject.put(s.c.a.d, jSONObject3);
            }
            w.a(context).a(string, jSONObject, w.a.NEWSESSION);
            bf.a(g);
            ap.b(g);
            a(a2);
            return true;
        } catch (Throwable th) {
            return false;
        }
    }

    private void a(SharedPreferences sharedPreferences) {
        SharedPreferences.Editor edit = sharedPreferences.edit();
        edit.remove(f1077a);
        edit.remove(b);
        edit.remove("a_start_time");
        edit.remove("a_end_time");
        edit.commit();
    }

    public String b(Context context) {
        String c2 = bv.c(context);
        String appkey = AnalyticsConfig.getAppkey(context);
        long currentTimeMillis = System.currentTimeMillis();
        if (appkey == null) {
            throw new RuntimeException("Appkey is null or empty, Please check AndroidManifest.xml");
        }
        StringBuilder sb = new StringBuilder();
        sb.append(currentTimeMillis).append(appkey).append(c2);
        f = bw.a(sb.toString());
        return f;
    }

    public void c(Context context) {
        g = context;
        SharedPreferences a2 = ba.a(context);
        if (a2 != null) {
            SharedPreferences.Editor edit = a2.edit();
            int i = a2.getInt(a.B, 0);
            int parseInt = Integer.parseInt(bv.a(g));
            if (i != 0 && parseInt != i) {
                try {
                    edit.putInt("vers_code", i);
                    edit.putString("vers_name", a2.getString(a.C, ""));
                    edit.commit();
                } catch (Throwable th) {
                }
                if (g(context) == null) {
                    a(context, a2);
                }
                e(g);
                ar.b(g).b();
                f(g);
                ar.b(g).a();
            } else if (b(a2)) {
                by.c("Start new session: " + a(context, a2));
            } else {
                String string = a2.getString(c, null);
                edit.putLong("a_start_time", System.currentTimeMillis());
                edit.putLong("a_end_time", 0L);
                edit.commit();
                by.c("Extend current session: " + string);
            }
        }
    }

    public void d(Context context) {
        SharedPreferences a2 = ba.a(context);
        if (a2 != null) {
            if (a2.getLong("a_start_time", 0L) != 0 || !AnalyticsConfig.ACTIVITY_DURATION_OPEN) {
                long currentTimeMillis = System.currentTimeMillis();
                SharedPreferences.Editor edit = a2.edit();
                edit.putLong("a_start_time", 0L);
                edit.putLong("a_end_time", currentTimeMillis);
                edit.putLong(b, currentTimeMillis);
                edit.commit();
                return;
            }
            by.e("onPause called before onResume");
        }
    }

    private boolean b(SharedPreferences sharedPreferences) {
        long j = sharedPreferences.getLong("a_start_time", 0L);
        long j2 = sharedPreferences.getLong("a_end_time", 0L);
        long currentTimeMillis = System.currentTimeMillis();
        if (j != 0 && currentTimeMillis - j < AnalyticsConfig.kContinueSessionMillis) {
            by.e("onResume called before onPause");
            return false;
        } else if (currentTimeMillis - j2 <= AnalyticsConfig.kContinueSessionMillis) {
            return false;
        } else {
            String a2 = a();
            if (!TextUtils.isEmpty(a2)) {
                long j3 = sharedPreferences.getLong(b, 0L);
                if (j3 == 0) {
                    j3 = System.currentTimeMillis();
                }
                try {
                    JSONObject jSONObject = new JSONObject();
                    jSONObject.put(s.c.a.g, j3);
                    w.a(g).a(a2, jSONObject, w.a.END);
                } catch (Throwable th) {
                }
            }
            return true;
        }
    }

    private String a(Context context, SharedPreferences sharedPreferences) {
        ar b2 = ar.b(context);
        String b3 = b(context);
        long currentTimeMillis = System.currentTimeMillis();
        try {
            JSONObject jSONObject = new JSONObject();
            jSONObject.put("__e", currentTimeMillis);
            w.a(g).a(b3, jSONObject, w.a.BEGIN);
        } catch (Throwable th) {
        }
        a(context);
        SharedPreferences.Editor edit = sharedPreferences.edit();
        edit.putString(c, b3);
        edit.putLong(f1077a, System.currentTimeMillis());
        edit.putLong(b, 0L);
        edit.putLong("a_start_time", currentTimeMillis);
        edit.putLong("a_end_time", 0L);
        edit.putInt(a.B, Integer.parseInt(bv.a(context)));
        edit.putString(a.C, bv.b(context));
        edit.commit();
        b2.a((Object) true);
        return b3;
    }

    public boolean e(Context context) {
        boolean z = false;
        SharedPreferences a2 = ba.a(context);
        if (!(a2 == null || a2.getString(c, null) == null)) {
            long j = a2.getLong("a_start_time", 0L);
            long j2 = a2.getLong("a_end_time", 0L);
            if (j > 0 && j2 == 0) {
                z = true;
                d(context);
            }
            long j3 = a2.getLong(b, 0L);
            try {
                JSONObject jSONObject = new JSONObject();
                if (j3 == 0) {
                    j3 = System.currentTimeMillis();
                }
                jSONObject.put(s.c.a.g, j3);
                w.a(g).a(a(), jSONObject, w.a.END);
            } catch (Throwable th) {
            }
            a(context);
        }
        return z;
    }

    public void f(Context context) {
        SharedPreferences a2 = ba.a(context);
        if (a2 != null) {
            String b2 = b(context);
            SharedPreferences.Editor edit = a2.edit();
            long currentTimeMillis = System.currentTimeMillis();
            edit.putString(c, b2);
            edit.putLong(f1077a, System.currentTimeMillis());
            edit.putLong(b, 0L);
            edit.putLong("a_start_time", currentTimeMillis);
            edit.putLong("a_end_time", 0L);
            edit.putInt(a.B, Integer.parseInt(bv.a(context)));
            edit.putString(a.C, bv.b(context));
            try {
                JSONObject jSONObject = new JSONObject();
                jSONObject.put("__e", currentTimeMillis);
                w.a(g).a(b2, jSONObject, w.a.BEGIN);
            } catch (Throwable th) {
            }
            edit.commit();
        }
    }

    public static String g(Context context) {
        if (f == null) {
            f = ba.a(context).getString(c, null);
        }
        return f;
    }

    public static String a() {
        return g(g);
    }
}
